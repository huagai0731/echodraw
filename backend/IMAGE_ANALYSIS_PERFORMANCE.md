# 图像分析性能优化说明

## 图片尺寸配置

图像分析功能会自动压缩图片以优化性能。默认配置已优化为 **1536px**（从 2048px 降低）。

### 性能对比

| 图片尺寸 | 像素数 | 相对计算量 | 内存占用 | 处理时间 | 适用场景 |
|---------|--------|-----------|---------|---------|---------|
| **1536px** (默认) | 2.36M | 100% | ~400MB | 1-2分钟 | **推荐：平衡性能和质量** |
| 2048px | 4.19M | 177% | ~600MB | 2-3分钟 | 高质量需求 |
| 1280px | 1.64M | 69% | ~300MB | 30秒-1分钟 | 资源受限环境 |

### 配置方法

在 `.env` 文件中设置：

```env
# 图像分析最大边长（像素）
# 1536: 推荐值，平衡性能和质量
# 2048: 高质量但更耗资源
# 1280: 更快的处理速度
IMAGE_ANALYSIS_MAX_SIDE=1536
```

### 性能影响

**从 2048px 降到 1536px 的效果：**
- ✅ 计算量减少约 **44%**
- ✅ 内存占用减少约 **33%**
- ✅ 处理时间减少约 **30-40%**
- ✅ 可以同时运行更多任务

**质量影响：**
- 对于大多数分析场景，1536px 已经足够
- 细节分析（如纹理方向）可能略有影响，但通常可接受
- 如果对质量要求很高，可以设置为 2048px

## 服务器资源建议

### 4核8G 服务器

**推荐配置：**
- 图片尺寸：**1536px**（默认）
- Worker 并发：**2-3 个任务**
- 同时运行：**2-3 个分析任务**

**启动命令：**
```bash
celery -A config worker --loglevel=info --concurrency=2
```

### 8核16G 服务器

**推荐配置：**
- 图片尺寸：**2048px**（高质量）
- Worker 并发：**4-6 个任务**
- 同时运行：**4-6 个分析任务**

**启动命令：**
```bash
celery -A config worker --loglevel=info --concurrency=4
```

## 进一步优化

### 1. 降低到 1280px（如果资源非常紧张）

在 `.env` 中设置：
```env
IMAGE_ANALYSIS_MAX_SIDE=1280
```

**效果：**
- 计算量再减少约 **31%**
- 处理时间减少到 30秒-1分钟
- 适合大量并发场景

### 2. 动态调整（根据服务器负载）

可以根据服务器负载动态调整图片尺寸，但这需要更复杂的实现。

### 3. 用户选择（可选功能）

可以让用户在前端选择分析质量：
- 快速模式：1280px
- 标准模式：1536px（默认）
- 高质量模式：2048px

## 监控建议

建议监控以下指标：
- CPU 使用率（目标：<80%）
- 内存使用率（目标：<85%）
- 任务队列长度
- 平均处理时间

如果资源经常满载，考虑：
1. 降低 `IMAGE_ANALYSIS_MAX_SIDE`
2. 减少 Worker 并发数
3. 添加任务限流
4. 升级服务器配置

